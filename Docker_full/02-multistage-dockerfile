# Multi-Stage Dockerfile Examples

## 1. Python Application with Testing and Security Scanning
# Stage 1: Testing
FROM python:3.11-slim AS test

WORKDIR /app

COPY requirements.txt requirements-dev.txt ./
RUN pip install --no-cache-dir -r requirements.txt -r requirements-dev.txt

COPY . .

RUN pytest tests/ --cov=. --cov-report=html
RUN pylint **/*.py
RUN bandit -r . -f json -o bandit-report.json

# Stage 2: Build
FROM python:3.11-slim AS build

WORKDIR /app

COPY requirements.txt .
RUN pip install --no-cache-dir --user -r requirements.txt

# Stage 3: Production
FROM python:3.11-slim

WORKDIR /app

# Copy only necessary files from build stage
COPY --from=build /root/.local /root/.local
COPY --from=test /app .

# Remove test files
RUN rm -rf tests/ requirements-dev.txt

# Make sure scripts in .local are usable:
ENV PATH=/root/.local/bin:$PATH

# Create non-root user
RUN useradd -m -u 1000 appuser && chown -R appuser:appuser /app
USER appuser

EXPOSE 8000

HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
  CMD python -c "import requests; requests.get('http://localhost:8000/health')" || exit 1

CMD ["python", "app.py"]


## 2. React Application with Nginx
# Stage 1: Dependencies
FROM node:18-alpine AS deps

WORKDIR /app

COPY package.json package-lock.json ./
RUN npm ci --only=production

# Stage 2: Build
FROM node:18-alpine AS builder

WORKDIR /app

COPY package.json package-lock.json ./
RUN npm ci

COPY . .
RUN npm run build
RUN npm run test

# Stage 3: Production with Nginx
FROM nginx:alpine

# Copy custom nginx config
COPY nginx.conf /etc/nginx/conf.d/default.conf

# Copy built app from builder stage
COPY --from=builder /app/build /usr/share/nginx/html

# Add healthcheck
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
  CMD wget --quiet --tries=1 --spider http://localhost:80/health || exit 1

EXPOSE 80

CMD ["nginx", "-g", "daemon off;"]


## 3. Microservice with Multiple Binaries
# Stage 1: Build Service A
FROM golang:1.21-alpine AS build-service-a

WORKDIR /app

COPY go.mod go.sum ./
RUN go mod download

COPY cmd/service-a ./cmd/service-a
COPY pkg ./pkg

RUN CGO_ENABLED=0 go build -o service-a ./cmd/service-a

# Stage 2: Build Service B
FROM golang:1.21-alpine AS build-service-b

WORKDIR /app

COPY go.mod go.sum ./
RUN go mod download

COPY cmd/service-b ./cmd/service-b
COPY pkg ./pkg

RUN CGO_ENABLED=0 go build -o service-b ./cmd/service-b

# Stage 3: Production
FROM alpine:latest

RUN apk --no-cache add ca-certificates

WORKDIR /app

# Copy both binaries
COPY --from=build-service-a /app/service-a .
COPY --from=build-service-b /app/service-b .

# Copy startup script
COPY entrypoint.sh .
RUN chmod +x entrypoint.sh

EXPOSE 8080 8081

ENTRYPOINT ["./entrypoint.sh"]


## 4. Full-Stack Application (Frontend + Backend + Database Client)
# Stage 1: Build Backend
FROM maven:3.9-eclipse-temurin-17 AS backend-build

WORKDIR /backend

COPY backend/pom.xml .
COPY backend/src ./src

RUN mvn clean package -DskipTests

# Stage 2: Build Frontend
FROM node:18-alpine AS frontend-build

WORKDIR /frontend

COPY frontend/package*.json ./
RUN npm ci

COPY frontend/ .
RUN npm run build

# Stage 3: Production
FROM eclipse-temurin:17-jre-alpine

WORKDIR /app

# Install nginx for serving frontend
RUN apk add --no-cache nginx

# Copy backend JAR
COPY --from=backend-build /backend/target/*.jar app.jar

# Copy frontend build
COPY --from=frontend-build /frontend/dist /usr/share/nginx/html

# Copy nginx configuration
COPY nginx.conf /etc/nginx/http.d/default.conf

# Copy startup script
COPY start.sh .
RUN chmod +x start.sh

EXPOSE 80 8080

CMD ["./start.sh"]


## 5. Development vs Production Dockerfile
# Development Stage
FROM python:3.11-slim AS development

WORKDIR /app

# Install dev dependencies
RUN pip install --no-cache-dir debugpy pytest pytest-cov black flake8

COPY requirements.txt requirements-dev.txt ./
RUN pip install --no-cache-dir -r requirements.txt -r requirements-dev.txt

COPY . .

# Enable hot reload
ENV FLASK_ENV=development
ENV FLASK_DEBUG=1

EXPOSE 8000 5678

CMD ["python", "-m", "debugpy", "--listen", "0.0.0.0:5678", "--wait-for-client", "app.py"]

# Production Stage
FROM python:3.11-slim AS production

WORKDIR /app

COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

COPY . .

# Remove dev files
RUN rm -rf tests/ requirements-dev.txt .pytest_cache __pycache__

# Security hardening
RUN useradd -m -u 1000 appuser && chown -R appuser:appuser /app
USER appuser

ENV FLASK_ENV=production

EXPOSE 8000

CMD ["gunicorn", "--bind", "0.0.0.0:8000", "--workers", "4", "app:app"]
